name: Deploy to CloudHub 2.0

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  MAVEN_OPTS: '-Xmx3072m'
  JAVA_VERSION: '17'
  MULE_VERSION: '4.10.0'

jobs:
  deploy-sandbox:
    name: Deploy to Sandbox
    runs-on: ubuntu-latest
    environment: 
      name: sandbox
      url: https://dex-401-training-mule.us-e2.cloudhub.io
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Auto-increment version
        id: version
        run: |
          # Get current version from pom.xml
          CURRENT_VERSION=$(grep -m 1 '<version>' pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
          
          # Extract major.minor from version (e.g., 1.0 from 1.0.0-SNAPSHOT)
          BASE_VERSION=$(echo $CURRENT_VERSION | sed 's/-SNAPSHOT//' | cut -d'.' -f1,2)
          
          # Use timestamp-based version for uniqueness: major.minor.YYYYMMDDHHmmss
          TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
          
          # Create new version with timestamp
          NEW_VERSION="${BASE_VERSION}.${TIMESTAMP}"
          
          echo "Current version: $CURRENT_VERSION"
          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          
          # Update pom.xml
          sed -i.bak "s|<version>${CURRENT_VERSION}</version>|<version>${NEW_VERSION}</version>|" pom.xml
          rm pom.xml.bak || true

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Configure Maven settings
        env:
          ANYPOINT_CLIENT_ID: ${{ secrets.ANYPOINT_CLIENT_ID }}
          ANYPOINT_CLIENT_SECRET: ${{ secrets.ANYPOINT_CLIENT_SECRET }}
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<EOF
          <settings>
            <servers>
              <server>
                <id>anypoint-exchange-v3</id>
                <username>~~~Client~~~</username>
                <password>$ANYPOINT_CLIENT_ID~?~$ANYPOINT_CLIENT_SECRET</password>
              </server>
              <server>
                <id>mulesoft-releases</id>
                <username>~~~Client~~~</username>
                <password>$ANYPOINT_CLIENT_ID~?~$ANYPOINT_CLIENT_SECRET</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: Clear Maven cache for failed artifacts
        run: |
          # Remove cached failures for org.everit.json.schema
          rm -rf ~/.m2/repository/com/github/everit-org.json-schema/ || true
          
      - name: Build and Package
        run: |
          mvn clean package -DskipTests -U
          echo "Built artifact: $(ls -lh target/*.jar)"

      - name: Publish to Anypoint Exchange
        env:
          ANYPOINT_CLIENT_ID: ${{ secrets.ANYPOINT_CLIENT_ID }}
          ANYPOINT_CLIENT_SECRET: ${{ secrets.ANYPOINT_CLIENT_SECRET }}
        run: |
          echo "Publishing to Exchange with version: ${{ steps.version.outputs.version }}"
          echo "GroupId: bdc363af-79af-48f0-9e26-e6f5fd1bee9c"
          echo "ArtifactId: dex-401-training-mule"
          mvn deploy -DskipTests \
            -DaltDeploymentRepository=anypoint-exchange-v3::default::https://maven.anypoint.mulesoft.com/api/v3/organizations/bdc363af-79af-48f0-9e26-e6f5fd1bee9c/maven

      - name: Deploy to CloudHub 2.0 Sandbox from Exchange
        env:
          ANYPOINT_CLIENT_ID: ${{ secrets.ANYPOINT_CLIENT_ID }}
          ANYPOINT_CLIENT_SECRET: ${{ secrets.ANYPOINT_CLIENT_SECRET }}
        run: |
          echo "Deploying version ${{ steps.version.outputs.version }} from Exchange to CloudHub 2.0"
          mvn mule:deploy \
            -Danypoint.connectedApp.clientId=$ANYPOINT_CLIENT_ID \
            -Danypoint.connectedApp.clientSecret=$ANYPOINT_CLIENT_SECRET \
            -Danypoint.businessGroupId=bdc363af-79af-48f0-9e26-e6f5fd1bee9c \
            -Dcloudhub2.environment=Sandbox \
            -Dcloudhub2.applicationName=dex-401-training-mule \
            -Dcloudhub2.target=Cloudhub-US-East-2 \
            -Dcloudhub2.muleVersion=4.10.1 \
            -Dcloudhub2.replicas=1 \
            -Dcloudhub2.vCores=0.1
